---
title: "使用 Hilbert 曲线可视化 CPAN 上 Perl 模块分布"
slug: "Visualize CPAN modules with Hilbert curve"
date: 2023-01-09
author: 顾祖光
---

```{r, echo = FALSE}
library(knitr)
knitr::opts_chunk$set(
    error = FALSE,
    tidy  = FALSE,
    message = FALSE,
    warning = FALSE,
    fig.width = 8,
    fig.height = 8,
    fig.align = "center"
)
```

在网站 http://mapofcpan.org/ 上有一个非常好看的对CPAN Perl模块可视化的例子，如下图：

<img src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdJN06UTIicSaVyvzkzZOmaSBs7YkJzBQ1g3p2P6eHYKeic2oQT48hDJwAVqhnwhl0r3jCoavUNzb7A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=0" />

在这篇文章中，我将展示如何使用R包**HilbertCurve**来绘制这样的图。

我们首先读入CPAN上所有模块的名字，这个可以在 https://www.cpan.org/modules/02packages.details.txt 中找到。下面我们直接将这个文件读入：

```{r}
df = read.table("https://www.cpan.org/modules/02packages.details.txt", skip = 9)
head(df)
```

模块的名字在第一列中，我们首先将其排序。


```{r}
all_modules = sort(df[, 1])
```

我们取每个模块的“命名空间”。命名空间是第一个`::`前面的字符串。注意，在Perl中，这可能不叫做命名空间，在这篇文章，为方便起见，我们称之为命名空间。

```{r}
ns = gsub("::.*$", "", all_modules)
```

现在`ns`是一个字符串向量，下面我们将其中的每一个值对应到一条Hilbert曲线上。我们首次将其转换为一个`Rle`对象。


```{r}
library(IRanges)
r = Rle(ns)
```

`Rle`是一个很简单的类，定义在**IRanges**包中。在变量`r`中，每一个元素对应着`ns`中一个单独的命名空间，在向量`ns`中，每一个命名空间的位置和长度也被计算出。在下面的代码中，我们提取出这些信息：

```{r}
s = start(r)          # start position of each ns in r
e = end(r)            # end position of each ns in r
w = width(r)          # width of each ns in r
labels = runValue(r)  # corresponding labels
```

现在我们可以进行Hilbert曲线可视化了。我们将最大的30个命名空间高亮和加上名字。


```{r, fig.width = 8, fig.height = 8}
library(HilbertCurve)

ind = order(w, decreasing = TRUE)[1:30]
w_cutoff = w[ ind[30] ]

set.seed(123)  # because we have randomm colors
hc = HilbertCurve(0, length(all_modules), level = 8, mode = "pixel")
hc_layer(hc, x1 = s, x2 = e, 
	col = circlize::rand_color(nrun(r), transparency = ifelse(w >= w_cutoff, 0, 0.8)))
hc_text(hc, x1 = s[ind], x2 = e[ind], labels = labels[ind], 
	gp = gpar(fontsize = 9))
```

注意，部分文字的位置不是非常好，这以后可以改进。


可能会有人会说，这个其实就是可视化不同类别中软件包的数目，本质上和barplot一样。其实只说对了一半。的确，可视化的信息和barplot是一样的，
但是barplot本质上只是一维上的可视化，而Hilbert曲线是一种”二维“上的可视化技术。如果非要找一种类似的可视化技术，那么应该和Bubble chart比较类似
https://r-graph-gallery.com/circle-packing.html 。

```{r}
sessionInfo()
```

<p id="license">本文使用 <a href='https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans'>CC BY-NC-SA 4.0</a> 协议发布。</p>

