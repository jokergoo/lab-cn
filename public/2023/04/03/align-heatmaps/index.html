<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="A website built through Hugo and blogdown.">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


    
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400&display=swap" rel="stylesheet" media="print" type="text/css" onload="this.media='all'">
    

    


<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />




    <title>
      
      
         Align heatmaps 
      
    </title>
    <link rel="canonical" href="lab-cn/2023/04/03/align-heatmaps/">

    <style>
  * {
    border:0;
    font:inherit;
    vertical-align:baseline;
    margin:0;
    padding:0;
    color: black;
    text-decoration-skip: ink;
    overflow-wrap: break-word;
  }

  body {
    font-family: Georgia,serif;
    line-height:160%;
    color:#1d1313;
    max-width:1000px;
    margin:auto;
    min-height: 600px;
    font-size: 17px;
  }

  p {
    margin: 20px 0;
  }

  a img {
    border:none;
  }

  img {
    margin: 10px auto 10px auto;
    max-width: 100%;
    display: block;
  }

  .left-justify { float: left; }
  .right-justify { float:right; }

  pre, code {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
    background-color: #f7f7f7;
  }

  code {
    padding: 4px;
  }

  pre {
    margin-top: 0;
    margin-bottom: 16px;
    word-wrap: normal;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
  }

  pre>code {
    padding: 0;
    margin: 0;
    font-size: 100%;
    word-break: normal;
    white-space: pre;
    background: transparent;
    border: 0;
  }

  pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: transparent;
    border: 0;
  }

  pre code::before,
  pre code::after {
    content: normal;
  }

  em,q,em,dfn {
    font-style:italic;
  }

  .sans,html .gist .gist-file .gist-meta {
    font-family:"Open Sans","Myriad Pro",Myriad,sans-serif;
  }

  .mono,pre,code,tt,p code,li code {
    font-family:Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
  }

  strong {
    font-weight:600;
  }

  q:before {
    content:"\201C";
  }

  q:after {
    content:"\201D";
  }

  del,s {
    text-decoration:line-through;
  }

  blockquote {
    font-family:"Old Standard TT",serif;
    text-align:center;
    padding:50px;
  }

  blockquote p {
    display:inline-block;
    font-style:italic;
  }

  blockquote:before,blockquote:after {
    font-family:"Old Standard TT",serif;
    content:'\201C';
    color:#403c3b;
  }

  blockquote:after {
    content:'\201D';
  }

  hr {
    width:40%;
    height: 1px;
    background:#403c3b;
    margin: 25px auto;
  }


  h2, h3 {
    margin-top: 40px;
    margin-bottom: 20px;
  }

  h1 a,h2 a,h3 a {
    text-decoration:none;
  }

  h1,h2 {
    margin-top:28px;
  }

  h1 {
    font-size: 2em;
  }

  h2, h3 {
    font-size: 1.5em;
  }

  #sub-header, .date {
    color:#403c3b;
  }

  #sub-header {
    margin: 0 4px;
    font-style: italic;
  }

  #nav h1 a {
    color:#1d1313;
    line-height:120%;
  }

  .posts_listing a,#nav a {
    text-decoration: none;
  }

  li {
    margin-left: 20px;
  }

  ul li {
    margin-left: 20px;
    padding-top: 2px;
    padding-bottom: 2px;
  }


  #nav ul li:before, .posts_listing li:before {
    content:'';
    margin-right:0;
  }

  #content {
    text-align:left;
    width:100%;
    padding:30px 0 80px;
  }

  #content h1,#content h2 {
    margin-bottom:5px;
  }

  #content .entry-content {
    margin-top:15px;
  }

  #content .date {
    margin-left:3px;
  }


  .highlight {
    margin: 10px 0;
  }

  .posts_listing {
    margin:0 0 50px;
  }

  .posts_listing li {
    margin:0 0 25px 15px;
  }

 
  #nav {
    text-align:center;
    position:static;
    margin-top:60px;
  }

  a {
    text-decoration: underline;
    text-decoration-color: #CCC;
    text-underline-offset: 5px;
  }

  a:hover {
    text-decoration-color: black;
  }

  
  #nav li {
    list-style-type:none;
    display:table-cell;
    padding: 0 20px;
  }

  #links {
    display: flex;
    justify-content: space-between;
    margin: 50px 0 0 0;
  }

  #links :nth-child(1) {
    margin-right:0.5em;;
  }

  #links :nth-child(2) {
    margin-left:0.5em;;
  }

  #not-found {
    text-align: center;
  }

  #not-found a {
    font-size: 3em;
    text-decoration: none;
    display: inline-block;
    padding-top: 225px;
    padding-bottom: 225px;
  }


#soft-info table td {
  padding: 2px 10px 2px 0px;
}

#license {
  font-style: italic;
  padding-top: 10px;
  padding-bottom: 10px;
  color:#403c3b;
}
#license a {
  color:#403c3b;
}
  @media (max-width: 750px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:28px;
    }

    #nav li {
      font-size:13px;
      padding: 0 5px;
    }

    #content {
      margin-top:0;
      padding-top:50px;
      font-size:14px;
    }

    #content h1 {
      font-size:25px;
    }

    #content h2 {
      font-size:22px;
    }

    .posts_listing li div {
      font-size:12px;
    }
  }

  @media (max-width: 400px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:22px;
    }

    #nav li {
      font-size:12px;
      padding: 0 5px;
    }

    #content {
      margin-top:0;
      padding-top:20px;
      font-size:12px;
    }

    #content h1 {
      font-size:20px;
    }

    #content h2 {
      font-size:18px;
    }

    .posts_listing li div{
      font-size:12px;
    }
  }

  @media (prefers-color-scheme: dark) {
    *, #nav h1 a {
      color: #FDFDFD;
    }

    body {
      background: #121212;
    }

    pre, code {
      background-color: #262626;
    }

    #sub-header, .date {
      color: #BABABA;
    }

    hr {
      background: #EBEBEB;
    }
  }
</style>


    </head>
<style>
#nav-logo-text {
    float: left;
    margin-top: 0px;
    margin-left: 0px;
    font-size: 2em;
    font-weight: 100;
}
#at {
  font-size:24px;
  padding:0px 2px;
}
</style>
<script>
window.root_dir = "lab-cn\/";
const regex = /^https?:\/\/[^/]+?\//;
root_dir = root_dir.replace(regex, "/");
$( function() {
  $("#content img").each(function(i) {
        var old_src = $(this).attr("src");
        var pattern = new RegExp("^" + root_dir);
        if(!pattern.test(old_src)) {
            pattern = /^http(s?):\/\//;
            if(!pattern.test(old_src)) {
                $(this).attr("src", root_dir + "/" + old_src);
            }
        }
    });
  $("#nav-logo-text").attr("href", root_dir);
  $("#no-found-a").attr("href", root_dir);

  var url = window.location.href;
  var pattern = /lab-cn/;
  var url2 = url.replace(pattern, "lab-en");
  $("#nav ul li:last-child a").attr("href", url2);
})
</script>
  <body>
    <section id=nav>
      <h1><a class="h-card" href="/"></a></h1>
      <a href="#" id="nav-logo-text">Gu<span style="padding:0px 2px">.</span>Z<span id="at">@</span>SUAT-SZ</a>
      <ul style="float:right">
        
          <li><a href="lab-cn/research/">研究</a></li>
        
          <li><a href="lab-cn/publication/">论文</a></li>
        
          <li><a href="lab-cn/software/">软件</a></li>
        
          <li><a href="lab-cn/post">博客</a></li>
        
          <li><a href="lab-cn/members/">成员</a></li>
        
          <li><a href="lab-cn/opening/">职位</a></li>
        
          <li><a href="lab-en/">EN</a></li>
        
      </ul>
      <div style="clear:both"></div>
    </section>


<section id=content>
  <h1 style="margin-bottom: 40px"> Align heatmaps </h1>

  
    <div id=sub-header>
      Zuguang Gu · April 2023 · <a href="#license">版权信息</a>
    </div>
  

  <div class="entry-content">
    <p><strong>ComplexHeatmap</strong> can make a list of heatmap where rows or columns in different heatmaps can be easily
corresponded. However, in some scenarios, users may only want to combine multiple plots into one single and large plot,
where each plot is like a figure panel. Normally we use <strong>cowplot</strong> or <strong>patchwork</strong> package, or even manually with
<code>pushViewport()</code>/<code>viewport()</code> functions to combine multiple figure panels, but for heatmaps, users may additionally
want all heatmaps are aligned by the heatmap bodies, while not by the whole heatmap plot.</p>
<p>To illustrate the problem, I first create two heatmaps where one contains 20 rows/5 columns, and the second heatmap
contains 30 rows/4 columns. Also they have different widths for row dendrograms, and they have different row names.</p>
<pre><code class="language-r">library(ComplexHeatmap)
m1 = matrix(rnorm(20*5), nrow = 5)
rownames(m1) = letters[1:5]
ht1 = Heatmap(m1, col = c(&quot;blue&quot;, &quot;white&quot;, &quot;red&quot;),
    column_km = 2, show_column_dend = FALSE, 
    show_heatmap_legend = FALSE, row_dend_width = unit(1, &quot;cm&quot;),
    column_title = &quot;This is heatmap 1&quot;)

m2 = matrix(rnorm(30*4), nrow = 4)
rownames(m2) = month.name[1:4]
ht2 = Heatmap(m2, col = c(&quot;blue&quot;, &quot;black&quot;, &quot;yellow&quot;),
    column_km = 3, show_column_dend = FALSE, 
    show_heatmap_legend = FALSE, row_dend_width = unit(3, &quot;cm&quot;),
    column_title = &quot;This is heatmap 2&quot;)
</code></pre>
<p>Next we use <strong>cowplot</strong> package to vertically combine the two heatmaps:</p>
<pre><code class="language-r">p1 = grid.grabExpr(draw(ht1))
p2 = grid.grabExpr(draw(ht2))

library(cowplot)
plot_grid(p1, p2, nrow = 2)
</code></pre>
<img src="/lab-cn/post/2023-04-03-align-heatmaps_files/figure-html/unnamed-chunk-3-1.png" width="768" style="display: block; margin: auto;" />
<p>As can be seen in the plot above, due to the different numbers of columns, different dendrogram widths and different
widths for row names, the two heatmaps are not aligned by the heatmap bodies, which makes the plot looking ugly.</p>
<p>To perfectly align heatmaps by their bodies, the key thing is to calculate the total width of all its left heatmap components
and the total width of all its right heatmap components. This is a two-step process.</p>
<p>First we need to process the heatmap object by the function <code>prepare()</code>. <code>prepare()</code> is normally internally used, which initializes
the layout of the heatmap and calculates the size of each heatmap component.</p>
<pre><code class="language-r">ht1 = prepare(ht1)
ht2 = prepare(ht2)
</code></pre>
<p>Second, we can use <code>component_width()</code> to obtain the widths of heatmap components. In a heatmap, horizontally, there are nine heatmap
componets, which are left title, left dendrogram, left row lables, left annotation, heatmap body, right annotation, right row labels,
right dendrogram and right title.</p>
<p>The following code calculates the total width of the componets on the left, and on the right of the heatmap body.</p>
<pre><code class="language-r">left1 = sum(component_width(ht1, 1:4))
left2 = sum(component_width(ht2, 1:4))
max_left = max(left1, left2)

right1 = sum(component_width(ht1, 6:9))
right2 = sum(component_width(ht2, 6:9))
max_right = max(right1, right2)
</code></pre>
<p>With <code>max_left</code> and <code>max_right</code>, we can calculate a proper offset and size for each heatmap, and align heatmaps perfectly by the
heamtap bodies.</p>
<p>Similar as before, the heatmaps are captured as grid objects:</p>
<pre><code class="language-r">p1 = grid.grabExpr(draw(ht1))
p2 = grid.grabExpr(draw(ht2))
</code></pre>
<p>In the last chunk of code, we manually create viewports and put heatmaps in. Note
for each heatmap, we calculate <code>offset_left</code> and <code>offset_right</code> based on <code>max_left</code> and <code>max_right</code>,
then we can set a proper offset and width for each heatmap.</p>
<pre><code class="language-r">grid.newpage()

pushViewport(viewport(y = 0, height = unit(0.5, &quot;npc&quot;), just = &quot;bottom&quot;))
offset_left = max_left - left1
offset_right = max_right - right1
pushViewport(viewport(x = offset_left, width = unit(1, &quot;npc&quot;) - offset_left - offset_right, just = &quot;left&quot;))
grid.draw(p1)
popViewport()
popViewport()

pushViewport(viewport(y = 0.5, height = unit(0.5, &quot;npc&quot;), just = &quot;bottom&quot;))
offset_left = max_left - left2
offset_right = max_right - right2
pushViewport(viewport(x = offset_left, width = unit(1, &quot;npc&quot;) - offset_left - offset_right, just = &quot;left&quot;))
grid.draw(p2)
popViewport()
popViewport()
</code></pre>
<img src="/lab-cn/post/2023-04-03-align-heatmaps_files/figure-html/unnamed-chunk-7-1.png" width="768" style="display: block; margin: auto;" />

  </div>


  <p id="license">本文使用 <a href='https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans'>CC BY-NC-SA 4.0</a> 协议发布。</p>


</section>


<style>
.footer p{
	color: #AAA;
	text-align: left;
	text-decoration: none;
	max-width:400px;
	border-top: 1px solid #AAA;
	padding-top:10px;
	font-size: 0.8em;
}
.footer p a {
	color: #AAA;
	text-align: left;
	text-decoration: none;
}
</style>

<footer class="footer">
<p>网站使用 <a href="https://gohugo.io/">Hugo</a>，<a href="https://bookdown.org/yihui/blogdown/">blogdown</a>，<a href="https://github.com/davidhampgonsalves/hugo-black-and-light-theme">Black & Light 主题</a>创建</p>
</footer>





<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>





</body>
</html>



