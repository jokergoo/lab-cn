<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="A website built through Hugo and blogdown.">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


    
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400&display=swap" rel="stylesheet" media="print" type="text/css" onload="this.media='all'">
    

    


<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />




    <title>
      
      
         Helper functions for genome-scale heatmap 
      
    </title>
    <link rel="canonical" href="lab-cn/2020/11/22/helper-functions-for-genome-scale-heatmap/">

    <style>
  * {
    border:0;
    font:inherit;
    vertical-align:baseline;
    margin:0;
    padding:0;
    color: black;
    text-decoration-skip: ink;
    overflow-wrap: break-word;
  }

  body {
    font-family: Georgia,serif;
    line-height:160%;
    color:#1d1313;
    max-width:1000px;
    margin:auto;
    min-height: 600px;
    font-size: 17px;
  }

  p {
    margin: 20px 0;
  }

  a img {
    border:none;
  }

  img {
    margin: 10px auto 10px auto;
    max-width: 100%;
    display: block;
  }

  .left-justify { float: left; }
  .right-justify { float:right; }

  pre, code {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
    background-color: #f7f7f7;
  }

  code {
    padding: 4px;
  }

  pre {
    margin-top: 0;
    margin-bottom: 16px;
    word-wrap: normal;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
  }

  pre>code {
    padding: 0;
    margin: 0;
    font-size: 100%;
    word-break: normal;
    white-space: pre;
    background: transparent;
    border: 0;
  }

  pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: transparent;
    border: 0;
  }

  pre code::before,
  pre code::after {
    content: normal;
  }

  em,q,em,dfn {
    font-style:italic;
  }

  .sans,html .gist .gist-file .gist-meta {
    font-family:"Open Sans","Myriad Pro",Myriad,sans-serif;
  }

  .mono,pre,code,tt,p code,li code {
    font-family:Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
  }

  strong {
    font-weight:600;
  }

  q:before {
    content:"\201C";
  }

  q:after {
    content:"\201D";
  }

  del,s {
    text-decoration:line-through;
  }

  blockquote {
    font-family:"Old Standard TT",serif;
    text-align:center;
    padding:50px;
  }

  blockquote p {
    display:inline-block;
    font-style:italic;
  }

  blockquote:before,blockquote:after {
    font-family:"Old Standard TT",serif;
    content:'\201C';
    color:#403c3b;
  }

  blockquote:after {
    content:'\201D';
  }

  hr {
    width:40%;
    height: 1px;
    background:#403c3b;
    margin: 25px auto;
  }


  h2, h3 {
    margin-top: 40px;
    margin-bottom: 20px;
  }

  h1 a,h2 a,h3 a {
    text-decoration:none;
  }

  h1,h2 {
    margin-top:28px;
  }

  h1 {
    font-size: 2em;
  }

  h2, h3 {
    font-size: 1.5em;
  }

  #sub-header, .date {
    color:#403c3b;
  }

  #sub-header {
    margin: 0 4px;
    font-style: italic;
  }

  #nav h1 a {
    color:#1d1313;
    line-height:120%;
  }

  .posts_listing a,#nav a {
    text-decoration: none;
  }

  li {
    margin-left: 20px;
  }

  ul li {
    margin-left: 20px;
    padding-top: 2px;
    padding-bottom: 2px;
  }


  #nav ul li:before, .posts_listing li:before {
    content:'';
    margin-right:0;
  }

  #content {
    text-align:left;
    width:100%;
    padding:30px 0 80px;
  }

  #content h1,#content h2 {
    margin-bottom:5px;
  }

  #content .entry-content {
    margin-top:15px;
  }

  #content .date {
    margin-left:3px;
  }


  .highlight {
    margin: 10px 0;
  }

  .posts_listing {
    margin:0 0 50px;
  }

  .posts_listing li {
    margin:0 0 25px 15px;
  }

 
  #nav {
    text-align:center;
    position:static;
    margin-top:60px;
  }

  a {
    text-decoration: underline;
    text-decoration-color: #CCC;
    text-underline-offset: 5px;
  }

  a:hover {
    text-decoration-color: black;
  }

  
  #nav li {
    list-style-type:none;
    display:table-cell;
    padding: 0 20px;
  }

  #links {
    display: flex;
    justify-content: space-between;
    margin: 50px 0 0 0;
  }

  #links :nth-child(1) {
    margin-right:0.5em;;
  }

  #links :nth-child(2) {
    margin-left:0.5em;;
  }

  #not-found {
    text-align: center;
  }

  #not-found a {
    font-size: 3em;
    text-decoration: none;
    display: inline-block;
    padding-top: 225px;
    padding-bottom: 225px;
  }


#soft-info table td {
  padding: 2px 10px 2px 0px;
}

#license {
  font-style: italic;
  padding-top: 10px;
  padding-bottom: 10px;
  color:#403c3b;
}
#license a {
  color:#403c3b;
}
  @media (max-width: 750px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:28px;
    }

    #nav li {
      font-size:13px;
      padding: 0 5px;
    }

    #content {
      margin-top:0;
      padding-top:50px;
      font-size:14px;
    }

    #content h1 {
      font-size:25px;
    }

    #content h2 {
      font-size:22px;
    }

    .posts_listing li div {
      font-size:12px;
    }
  }

  @media (max-width: 400px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:22px;
    }

    #nav li {
      font-size:12px;
      padding: 0 5px;
    }

    #content {
      margin-top:0;
      padding-top:20px;
      font-size:12px;
    }

    #content h1 {
      font-size:20px;
    }

    #content h2 {
      font-size:18px;
    }

    .posts_listing li div{
      font-size:12px;
    }
  }

  @media (prefers-color-scheme: dark) {
    *, #nav h1 a {
      color: #FDFDFD;
    }

    body {
      background: #121212;
    }

    pre, code {
      background-color: #262626;
    }

    #sub-header, .date {
      color: #BABABA;
    }

    hr {
      background: #EBEBEB;
    }
  }
</style>


    </head>
<style>
#nav-logo-text {
    float: left;
    margin-top: 0px;
    margin-left: 0px;
    font-size: 2em;
    font-weight: 100;
}
#at {
  font-size:24px;
  padding:0px 2px;
}
</style>
<script>
window.root_dir = "lab-cn\/";
const regex = /^https?:\/\/[^/]+?\//;
root_dir = root_dir.replace(regex, "/");
$( function() {
  $("#content img").each(function(i) {
        var old_src = $(this).attr("src");
        var pattern = new RegExp("^" + root_dir);
        if(!pattern.test(old_src)) {
            pattern = /^http(s?):\/\//;
            if(!pattern.test(old_src)) {
                $(this).attr("src", root_dir + "/" + old_src);
            }
        }
    });
  $("#nav-logo-text").attr("href", root_dir);
  $("#no-found-a").attr("href", root_dir);

  var url = window.location.href;
  var pattern = /lab-cn/;
  var url2 = url.replace(pattern, "lab-en");
  $("#nav ul li:last-child a").attr("href", url2);
})
</script>
  <body>
    <section id=nav>
      <h1><a class="h-card" href="/"></a></h1>
      <a href="#" id="nav-logo-text">Gu<span style="padding:0px 2px">.</span>Z<span id="at">@</span>SUAT-SZ</a>
      <ul style="float:right">
        
          <li><a href="lab-cn/research/">研究</a></li>
        
          <li><a href="lab-cn/publication/">论文</a></li>
        
          <li><a href="lab-cn/software/">软件</a></li>
        
          <li><a href="lab-cn/post">博客</a></li>
        
          <li><a href="lab-cn/members/">成员</a></li>
        
          <li><a href="lab-cn/opening/">职位</a></li>
        
          <li><a href="lab-en/">EN</a></li>
        
      </ul>
      <div style="clear:both"></div>
    </section>


<section id=content>
  <h1 style="margin-bottom: 40px"> Helper functions for genome-scale heatmap </h1>

  
    <div id=sub-header>
      Zuguang Gu · November 2020 · <a href="#license">版权信息</a>
    </div>
  

  <div class="entry-content">
    <p><a href="../../../../2020/10/29/make-genome-scale-heatmap/">In my previous blog
post</a>, I
demonstrated how to make a genome-scale heatmap with multiple other tracks.
The key thing there is to split the genome into bins and to normalize various
genomic signals to average them into every bin of the genome. From
<strong>ComplexHeatmap</strong> version 2.7.1.1003, I added some helper functions which
simplify the binning of the genome and the overlapping between genomic bins
and genomic signals with two new functions <code>bin_genome()</code> and
<code>normalize_genomic_signals_to_bins()</code>. Here I will introduce the usage of
these two functions.</p>
<p>The usage of <code>bin_genome()</code> is very straightforward. You just select the
genome and bin size, and optional, a subset of chromosomes.</p>
<pre><code class="language-r">library(ComplexHeatmap)
chr_window = bin_genome(&quot;hg19&quot;)
chr_window
</code></pre>
<pre><code>## GRanges object with 1990 ranges and 0 metadata columns:
##          seqnames            ranges strand
##             &lt;Rle&gt;         &lt;IRanges&gt;  &lt;Rle&gt;
##      [1]     chr1         1-1547839      *
##      [2]     chr1   1547840-3095678      *
##      [3]     chr1   3095679-4643517      *
##      [4]     chr1   4643518-6191356      *
##      [5]     chr1   6191357-7739195      *
##      ...      ...               ...    ...
##   [1986]     chrY 51078688-52626526      *
##   [1987]     chrY 52626527-54174365      *
##   [1988]     chrY 54174366-55722204      *
##   [1989]     chrY 55722205-57270043      *
##   [1990]     chrY 57270044-58817882      *
##   -------
##   seqinfo: 24 sequences from an unspecified genome; no seqlengths
</code></pre>
<p>The returned value <code>chr_window</code> is a <code>GRanges</code> object which contains the
genomic bins.</p>
<p>There are several parameters you can set in <code>bin_genome()</code>.</p>
<ul>
<li><code>species</code>: Abbreviation of the genome, <em>e.g.</em>, &ldquo;hg19&rdquo; or &ldquo;mm10&rdquo;.</li>
<li><code>bins</code>: Number of bins to split the genome. The final number will be
approximately equal to this number. <code>bins</code> is for calculating a proper
<code>bin_size</code> value.</li>
<li><code>bin_size</code>: The bin size. If it is set, <code>bins</code> is ignored.</li>
<li><code>...</code>: All the other arguments are passed to <code>circlize::read.chromInfo()</code>,
<em>e.g.</em> you can set the genome by a data frame if it is not available on UCSC
database, or you can set a subset of chromosomes by <code>chromosome.index</code>
argument.</li>
</ul>
<p>The second function <code>normalize_genomic_signals_to_bins()</code>, as the name tells, is
for normalizing the genomic signals to the genomic bins. The usage is:</p>
<pre><code class="language-r">x = normalize_genomic_signals_to_bins(gr, value, value_column, method, empty_value)
</code></pre>
<p>The arguments are:</p>
<ul>
<li><code>gr</code>: A <code>GRanges</code> object.</li>
<li><code>value</code>: The corresponding signals corresponding to <code>gr</code>.</li>
<li><code>value_column</code>: If <code>value</code> is not set and the values are in the meta-columns
in <code>gr</code>, you can specify the column indices for these value columns, better
to use name indices.</li>
<li><code>method</code>: One of &ldquo;weighted&rdquo;, &ldquo;w0&rdquo; and &ldquo;absolute&rdquo;. For the
three different methods, please refer to
<a href="https://bioconductor.org/packages/release/bioc/vignettes/EnrichedHeatmap/inst/doc/EnrichedHeatmap.html#toc_7">https://bioconductor.org/packages/release/bioc/vignettes/EnrichedHeatmap/inst/doc/EnrichedHeatmap.html#toc_7</a> or <a href="https://jokergoo.github.io/2020/10/29/make-genome-scale-heatmap/">my previous blog post</a></li>
<li><code>empty_value</code> The value for the bins where no signal is overlapped.</li>
</ul>
<p>It supports following values:</p>
<ul>
<li>When neither <code>value</code> nor <code>value_column</code> is set, it simply overlaps <code>gr</code>
to the genomic bins and returns a one-column logical matrix which represents
whether the current genomic bin overlaps to any signal.</li>
<li>When the signals are numeric, <code>value</code> can be a numeric vector or a matrix,
or <code>value_column</code> can contain multiple columns. The function returns a
numeric matrix where the values are properly averaged depending on what
<code>method</code> was used.</li>
<li>When the signals are character, <code>value</code> can only be a vector or
<code>value_column</code> can only contain one single column. The function returns a
one-column character matrix.</li>
</ul>
<p>You don&rsquo;t need to provide the the genomic bins for
<code>normalize_genomic_signals_to_bins()</code> because when <code>bin_genome()</code> is executed,
the genomic bins are saved internally, so every use of
<code>normalize_genomic_signals_to_bins()</code> can directly use the saved genomic bins
and it ensures multiple use of <code>normalize_genomic_signals_to_bins()</code> always
generate the matrices with the same rows.</p>
<p>That is basically everything, <code>normalize_genomic_signals_to_bins()</code> generates
a matrix and you can use it directly with function <code>Heatmap()</code> or other heatmap-related
fucntions.</p>
<p>The following is the example I generated in my previous blog post, but here I
rewrite it with the use of <code>bin_genome()</code> and <code>normalize_genomic_signals_to_bins()</code>.</p>
<pre><code class="language-r">library(ComplexHeatmap)
library(circlize)
library(GenomicRanges)

chr_window = bin_genome(&quot;hg19&quot;)

#### the first is a numeric matrix #######
bed1 = generateRandomBed(nr = 1000, nc = 10)
gr1 = GRanges(seqnames = bed1[, 1], ranges = IRanges(bed1[, 2], bed1[, 3]))

num_mat = normalize_genomic_signals_to_bins(gr1, bed1[, -(1:3)])

#### the second is a character matrix ######
bed_list = lapply(1:10, function(i) {
    generateRandomBed(nr = 1000, nc = 1, 
        fun = function(n) sample(c(&quot;gain&quot;, &quot;loss&quot;), n, replace = TRUE))
})
char_mat = NULL
for(i in 1:10) {
    bed = bed_list[[i]]
    bed = bed[sample(nrow(bed), 20), , drop = FALSE]
    gr_cnv = GRanges(seqnames = bed[, 1], ranges = IRanges(bed[, 2], bed[, 3]))

    char_mat = cbind(char_mat, normalize_genomic_signals_to_bins(gr_cnv, bed[, 4]))
}

#### two numeric columns ##########
bed2 = generateRandomBed(nr = 100, nc = 2)
gr2 = GRanges(seqnames = bed2[, 1], ranges = IRanges(bed2[, 2], bed2[, 3]))

v = normalize_genomic_signals_to_bins(gr2, bed2[, 4:5])

##### a list of genes need to be marked
bed3 = generateRandomBed(nr = 40, nc = 0)
gr3 = GRanges(seqnames = bed3[, 1], ranges = IRanges(bed3[, 2], bed3[, 2]))
gr3$gene = paste0(&quot;gene_&quot;, 1:length(gr3))

mtch = as.matrix(findOverlaps(chr_window, gr3))
at = mtch[, 1]
labels = mcols(gr3)[mtch[, 2], 1]

##### order of the chromosomes ########
chr = as.vector(seqnames(chr_window))
chr_level = paste0(&quot;chr&quot;, c(1:22, &quot;X&quot;, &quot;Y&quot;))
chr = factor(chr, levels = chr_level)

#### make the heatmap #######
subgroup = rep(c(&quot;A&quot;, &quot;B&quot;), each = 5)

ht_opt$TITLE_PADDING = unit(c(4, 4), &quot;points&quot;)
ht_list = Heatmap(num_mat, name = &quot;mat&quot;, col = colorRamp2(c(-1, 0, 1), c(&quot;green&quot;, &quot;white&quot;, &quot;red&quot;)),
        row_split = chr, cluster_rows = FALSE, show_column_dend = FALSE,
        column_split = subgroup, cluster_column_slices = FALSE,
        column_title = &quot;numeric matrix&quot;,
        top_annotation = HeatmapAnnotation(subgroup = subgroup, annotation_name_side = &quot;left&quot;),
        row_title_rot = 0, row_title_gp = gpar(fontsize = 10), border = TRUE,
        row_gap = unit(0, &quot;points&quot;)) +
    Heatmap(char_mat, name = &quot;CNV&quot;, col = c(&quot;gain&quot; = &quot;red&quot;, &quot;loss&quot; = &quot;blue&quot;),
        border = TRUE, column_title = &quot;character matrix&quot;) +
    rowAnnotation(label = anno_mark(at = at, labels = labels)) +
    rowAnnotation(pt = anno_points(v, gp = gpar(col = 4:5), pch = c(1, 16)), 
        width = unit(2, &quot;cm&quot;)) +
    rowAnnotation(bar = anno_barplot(v[, 1], gp = gpar(col = ifelse(v[ ,1] &gt; 0, 2, 3))), 
        width = unit(2, &quot;cm&quot;))
draw(ht_list, merge_legend = TRUE)
</code></pre>
<img src="/lab-cn/post/2020-11-22-helper-functions-for-genome-scale-heatmap_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" />
<p>Session Info:</p>
<pre><code class="language-r">sessionInfo()
</code></pre>
<pre><code>## R version 4.4.2 (2024-10-31)
## Platform: aarch64-apple-darwin20
## Running under: macOS 26.0.1
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0
## 
## locale:
## [1] C.UTF-8/UTF-8/C.UTF-8/C/C.UTF-8/C.UTF-8
## 
## time zone: Europe/Berlin
## tzcode source: internal
## 
## attached base packages:
## [1] stats4    grid      stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] GenomicRanges_1.58.0  GenomeInfoDb_1.42.3   IRanges_2.40.1       
##  [4] S4Vectors_0.44.0      BiocGenerics_0.52.0   circlize_0.4.16      
##  [7] ComplexHeatmap_2.25.2 GetoptLong_1.0.5      knitr_1.50           
## [10] colorout_1.3-2       
## 
## loaded via a namespace (and not attached):
##  [1] sass_0.4.9              shape_1.4.6.1           lattice_0.22-6         
##  [4] blogdown_1.19           magrittr_2.0.3          digest_0.6.37          
##  [7] evaluate_1.0.3          RColorBrewer_1.1-3      EnrichedHeatmap_1.36.0 
## [10] bookdown_0.44           iterators_1.0.14        fastmap_1.2.0          
## [13] foreach_1.5.2           doParallel_1.0.17       jsonlite_1.9.0         
## [16] GlobalOptions_0.1.2     httr_1.4.7              UCSC.utils_1.2.0       
## [19] codetools_0.2-20        jquerylib_0.1.4         cli_3.6.4              
## [22] rlang_1.1.5             crayon_1.5.3            XVector_0.46.0         
## [25] cachem_1.1.0            yaml_2.3.10             tools_4.4.2            
## [28] parallel_4.4.2          colorspace_2.1-1        locfit_1.5-9.12        
## [31] GenomeInfoDbData_1.2.13 R6_2.6.1                png_0.1-8              
## [34] magick_2.8.5            matrixStats_1.5.0       lifecycle_1.0.4        
## [37] zlibbioc_1.52.0         clue_0.3-66             cluster_2.1.6          
## [40] bslib_0.9.0             Rcpp_1.0.14             xfun_0.51              
## [43] rjson_0.2.23            htmltools_0.5.8.1       rmarkdown_2.29         
## [46] Cairo_1.6-2             compiler_4.4.2
</code></pre>

  </div>


  <p id="license">本文使用 <a href='https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans'>CC BY-NC-SA 4.0</a> 协议发布。</p>


</section>


<style>
.footer p{
	color: #AAA;
	text-align: left;
	text-decoration: none;
	max-width:400px;
	border-top: 1px solid #AAA;
	padding-top:10px;
	font-size: 0.8em;
}
.footer p a {
	color: #AAA;
	text-align: left;
	text-decoration: none;
}
</style>

<footer class="footer">
<p>网站使用 <a href="https://gohugo.io/">Hugo</a>，<a href="https://bookdown.org/yihui/blogdown/">blogdown</a>，<a href="https://github.com/davidhampgonsalves/hugo-black-and-light-theme">Black & Light 主题</a>创建</p>
</footer>





<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>




<script src="/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


</body>
</html>



