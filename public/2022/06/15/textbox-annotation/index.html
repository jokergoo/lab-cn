<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="A website built through Hugo and blogdown.">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


    
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400&display=swap" rel="stylesheet" media="print" type="text/css" onload="this.media='all'">
    

    


<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />




    <title>
      
      
         Textbox annotation 
      
    </title>
    <link rel="canonical" href="/lab-cn/2022/06/15/textbox-annotation/">

    <style>
  * {
    border:0;
    font:inherit;
    vertical-align:baseline;
    margin:0;
    padding:0;
    color: black;
    text-decoration-skip: ink;
    overflow-wrap: break-word;
  }

  body {
    font-family: Georgia,serif;
    line-height:160%;
    color:#1d1313;
    max-width:1000px;
    margin:auto;
    min-height: 600px;
    font-size: 17px;
  }

  p {
    margin: 20px 0;
  }

  a img {
    border:none;
  }

  img {
    margin: 10px auto 10px auto;
    max-width: 100%;
    display: block;
  }

  .left-justify { float: left; }
  .right-justify { float:right; }

  pre, code {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
    background-color: #f7f7f7;
  }

  code {
    padding: 4px;
  }

  pre {
    margin-top: 0;
    margin-bottom: 16px;
    word-wrap: normal;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
  }

  pre>code {
    padding: 0;
    margin: 0;
    font-size: 100%;
    word-break: normal;
    white-space: pre;
    background: transparent;
    border: 0;
  }

  pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: transparent;
    border: 0;
  }

  pre code::before,
  pre code::after {
    content: normal;
  }

  em,q,em,dfn {
    font-style:italic;
  }

  .sans,html .gist .gist-file .gist-meta {
    font-family:"Open Sans","Myriad Pro",Myriad,sans-serif;
  }

  .mono,pre,code,tt,p code,li code {
    font-family:Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
  }

  strong {
    font-weight:600;
  }

  q:before {
    content:"\201C";
  }

  q:after {
    content:"\201D";
  }

  del,s {
    text-decoration:line-through;
  }

  blockquote {
    font-family:"Old Standard TT",serif;
    text-align:center;
    padding:50px;
  }

  blockquote p {
    display:inline-block;
    font-style:italic;
  }

  blockquote:before,blockquote:after {
    font-family:"Old Standard TT",serif;
    content:'\201C';
    color:#403c3b;
  }

  blockquote:after {
    content:'\201D';
  }

  hr {
    width:40%;
    height: 1px;
    background:#403c3b;
    margin: 25px auto;
  }


  h2, h3 {
    margin-top: 40px;
    margin-bottom: 20px;
  }

  h1 a,h2 a,h3 a {
    text-decoration:none;
  }

  h1,h2 {
    margin-top:28px;
  }

  h1 {
    font-size: 2em;
  }

  h2, h3 {
    font-size: 1.5em;
  }

  #sub-header, .date {
    color:#403c3b;
  }

  #sub-header {
    margin: 0 4px;
    font-style: italic;
  }

  #nav h1 a {
    color:#1d1313;
    line-height:120%;
  }

  .posts_listing a,#nav a {
    text-decoration: none;
  }

  li {
    margin-left: 20px;
  }

  ul li {
    margin-left: 20px;
    padding-top: 2px;
    padding-bottom: 2px;
  }


  #nav ul li:before, .posts_listing li:before {
    content:'';
    margin-right:0;
  }

  #content {
    text-align:left;
    width:100%;
    padding:30px 0 80px;
  }

  #content h1,#content h2 {
    margin-bottom:5px;
  }

  #content .entry-content {
    margin-top:15px;
  }

  #content .date {
    margin-left:3px;
  }


  .highlight {
    margin: 10px 0;
  }

  .posts_listing {
    margin:0 0 50px;
  }

  .posts_listing li {
    margin:0 0 25px 15px;
  }

 
  #nav {
    text-align:center;
    position:static;
    margin-top:60px;
  }

  a {
    text-decoration: underline;
    text-decoration-color: #CCC;
    text-underline-offset: 5px;
  }

  a:hover {
    text-decoration-color: black;
  }

  
  #nav li {
    list-style-type:none;
    display:table-cell;
    padding: 0 20px;
  }

  #links {
    display: flex;
    justify-content: space-between;
    margin: 50px 0 0 0;
  }

  #links :nth-child(1) {
    margin-right:0.5em;;
  }

  #links :nth-child(2) {
    margin-left:0.5em;;
  }

  #not-found {
    text-align: center;
  }

  #not-found a {
    font-size: 3em;
    text-decoration: none;
    display: inline-block;
    padding-top: 225px;
    padding-bottom: 225px;
  }


#soft-info table td {
  padding: 2px 10px 2px 0px;
}

#license {
  font-style: italic;
  padding-top: 10px;
  padding-bottom: 10px;
  color:#403c3b;
}
#license a {
  color:#403c3b;
}
  @media (max-width: 750px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:28px;
    }

    #nav li {
      font-size:13px;
      padding: 0 5px;
    }

    #content {
      margin-top:0;
      padding-top:50px;
      font-size:14px;
    }

    #content h1 {
      font-size:25px;
    }

    #content h2 {
      font-size:22px;
    }

    .posts_listing li div {
      font-size:12px;
    }
  }

  @media (max-width: 400px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:22px;
    }

    #nav li {
      font-size:12px;
      padding: 0 5px;
    }

    #content {
      margin-top:0;
      padding-top:20px;
      font-size:12px;
    }

    #content h1 {
      font-size:20px;
    }

    #content h2 {
      font-size:18px;
    }

    .posts_listing li div{
      font-size:12px;
    }
  }

  @media (prefers-color-scheme: dark) {
    *, #nav h1 a {
      color: #FDFDFD;
    }

    body {
      background: #121212;
    }

    pre, code {
      background-color: #262626;
    }

    #sub-header, .date {
      color: #BABABA;
    }

    hr {
      background: #EBEBEB;
    }
  }
</style>


    </head>
<style>
#nav-logo-text {
    float: left;
    margin-top: 0px;
    margin-left: 0px;
    font-size: 2em;
    font-weight: 100;
}
#at {
  font-size:24px;
  padding:0px 2px;
}
</style>
<script>
window.root_dir = "\/lab-cn\/";
const regex = /^https?:\/\/[^/]+?\//;
root_dir = root_dir.replace(regex, "/");
$( function() {
  $("#content img").each(function(i) {
        var old_src = $(this).attr("src");
        var pattern = new RegExp("^" + root_dir);
        if(!pattern.test(old_src)) {
            pattern = /^http(s?):\/\//;
            if(!pattern.test(old_src)) {
                $(this).attr("src", root_dir + "/" + old_src);
            }
        }
    });
  $("#nav-logo-text").attr("href", root_dir);
  $("#no-found-a").attr("href", root_dir);

  var url = window.location.href;
  var pattern = /lab-cn/;
  var url2 = url.replace(pattern, "lab-en");
  $("#nav ul li:last-child a").attr("href", url2);
})
</script>
  <body>
    <section id=nav>
      <h1><a class="h-card" href="/"></a></h1>
      <a href="#" id="nav-logo-text">Gu<span style="padding:0px 2px">.</span>Z<span id="at">@</span>SUAT-SZ</a>
      <ul style="float:right">
        
          <li><a href="/lab-cn/research/">研究</a></li>
        
          <li><a href="/lab-cn/publication/">论文</a></li>
        
          <li><a href="/lab-cn/software/">软件</a></li>
        
          <li><a href="/lab-cn/post">博客</a></li>
        
          <li><a href="/lab-cn/members/">成员</a></li>
        
          <li><a href="/lab-cn/opening/">职位</a></li>
        
          <li><a href="/lab-en/">EN</a></li>
        
      </ul>
      <div style="clear:both"></div>
    </section>


<section id=content>
  <h1 style="margin-bottom: 40px"> Textbox annotation </h1>

  
    <div id=sub-header>
      Zuguang Gu · June 2022 · <a href="#license">版权信息</a>
    </div>
  

  <div class="entry-content">
    <p>In <a href="https://jokergoo.github.io/2020/05/31/word-cloud-as-heatmap-annotation/">a previous post &ldquo;Word cloud as heatmap
annotation&rdquo;</a>,
I introduced how to make word clouds and attach them to heatmaps as
annotations. Here I will introduce a more general solution for making
textboxes.</p>
<p>The following new functions are implemented in <strong>ComplexHeatmap</strong> from version
2.13.1. Now you need to update <strong>ComplexHeatmap</strong> from GitHub.</p>
<p>First I will demonstrate a low-level <code>grid.*</code> family function
<code>grid.textbox()</code>. The function simply accepts a vector of texts. If the <code>col</code>
parameter is not specified in <code>gpar()</code>, random colors are used.</p>
<pre><code class="language-r">library(ComplexHeatmap)
set.seed(888)
words = sapply(1:30, function(x) strrep(sample(letters, 1), sample(3:10, 1)))
grid.newpage()
grid.textbox(words, gp = gpar(fontsize = runif(30, min = 5, max = 30)))
</code></pre>
<img src="/lab-cn/post/2022-06-15-textbox-annotation_files/figure-html/unnamed-chunk-2-1.png" width="432" style="display: block; margin: auto;" />
<p><code>max_width</code> controls the maximal width of the textbox.</p>
<pre><code class="language-r">grid.newpage()
grid.textbox(words, gp = gpar(col = &quot;red&quot;, fontsize = 1:30+5), max_width = unit(9, &quot;in&quot;))
</code></pre>
<img src="/lab-cn/post/2022-06-15-textbox-annotation_files/figure-html/unnamed-chunk-3-1.png" width="960" style="display: block; margin: auto;" />
<p>Set <code>round_corners</code> to <code>TRUE</code>, also set background graphics parameters:</p>
<pre><code class="language-r">grid.newpage()
grid.textbox(words, gp = gpar(fontsize = runif(30, min = 5, max = 30)),
    background_gp = gpar(fill = &quot;#FFEEEE&quot;, lty = 2, col = &quot;grey&quot;), round_corners = TRUE,
    padding = unit(c(10, 20, 10, 20), &quot;pt&quot;))
</code></pre>
<img src="/lab-cn/post/2022-06-15-textbox-annotation_files/figure-html/unnamed-chunk-4-1.png" width="480" style="display: block; margin: auto;" />
<p>One feature of <code>grid.textbox()</code> is it can properly handle long phrases or sentences which are composed
by multiple words. By default, long phrases are treated as single words, which means, if there is no
enough space in a line, the whole phrase is moved to the next line.</p>
<pre><code class="language-r">sentenses = c(&quot;This is sentense 1&quot;, &quot;This is a long long long long long long long sentense.&quot;)
grid.newpage()
grid.textbox(sentenses)
</code></pre>
<img src="/lab-cn/post/2022-06-15-textbox-annotation_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" />
<p>Set <code>word_wrap = TRUE</code> so that long phrases are wrapped if they are too long:</p>
<pre><code class="language-r">grid.newpage()
grid.textbox(sentenses, word_wrap = TRUE)
</code></pre>
<img src="/lab-cn/post/2022-06-15-textbox-annotation_files/figure-html/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;" />
<p>If <code>add_new_line</code> is set to <code>TRUE</code>, each phrase is put in a separated line.</p>
<pre><code class="language-r">grid.newpage()
grid.textbox(sentenses, word_wrap = TRUE, add_new_line = TRUE)
</code></pre>
<img src="/lab-cn/post/2022-06-15-textbox-annotation_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" />
<p>Now we can implement the corresponding annotation function for heatmaps. In <strong>ComplexHeatmap</strong>,
there is a new annotation function <code>anno_textbox()</code>. The two major arguments for <code>anno_textbox()</code> are:</p>
<ul>
<li><code>align_to</code>: It controls how the text boxes are aligned to the heatmap rows.
The value can be a categorical vector which have the same length as
heatmap rows, or a list of row indices. It does not necessarily include
all row indices.</li>
<li><code>text</code>: The corresponding texts. The value should be a
list of texts. To control graphics parameters of texts in the boxes, The
value of <code>text</code> can also be set as a list of data frames where the
first column contains the text, from the second column contains graphics
parameters for each text. The column names should be &ldquo;col&rdquo;, &ldquo;fontsize&rdquo;,
&ldquo;fontfamily&rdquo; and &ldquo;fontface&rdquo;.</li>
</ul>
<pre><code class="language-r">library(circlize)
mat = matrix(rnorm(100*10), nrow = 100)

split = sample(letters[1:10], 100, replace = TRUE)
text = lapply(unique(split), function(x) {
    data.frame(month.name, col = rand_color(12, friendly = TRUE), fontsize = runif(12, 6, 14))
})
names(text) = unique(split)

split
</code></pre>
<pre><code>##   [1] &quot;b&quot; &quot;f&quot; &quot;h&quot; &quot;h&quot; &quot;c&quot; &quot;g&quot; &quot;a&quot; &quot;h&quot; &quot;d&quot; &quot;e&quot; &quot;g&quot; &quot;c&quot; &quot;j&quot; &quot;c&quot; &quot;c&quot; &quot;j&quot; &quot;a&quot; &quot;d&quot;
##  [19] &quot;i&quot; &quot;h&quot; &quot;a&quot; &quot;i&quot; &quot;g&quot; &quot;a&quot; &quot;b&quot; &quot;e&quot; &quot;i&quot; &quot;a&quot; &quot;c&quot; &quot;h&quot; &quot;j&quot; &quot;j&quot; &quot;b&quot; &quot;c&quot; &quot;c&quot; &quot;e&quot;
##  [37] &quot;j&quot; &quot;a&quot; &quot;d&quot; &quot;d&quot; &quot;j&quot; &quot;h&quot; &quot;j&quot; &quot;d&quot; &quot;b&quot; &quot;h&quot; &quot;e&quot; &quot;h&quot; &quot;b&quot; &quot;j&quot; &quot;a&quot; &quot;a&quot; &quot;a&quot; &quot;c&quot;
##  [55] &quot;g&quot; &quot;d&quot; &quot;b&quot; &quot;a&quot; &quot;a&quot; &quot;g&quot; &quot;b&quot; &quot;g&quot; &quot;h&quot; &quot;j&quot; &quot;g&quot; &quot;f&quot; &quot;i&quot; &quot;j&quot; &quot;a&quot; &quot;d&quot; &quot;i&quot; &quot;b&quot;
##  [73] &quot;c&quot; &quot;b&quot; &quot;f&quot; &quot;e&quot; &quot;h&quot; &quot;c&quot; &quot;a&quot; &quot;c&quot; &quot;a&quot; &quot;j&quot; &quot;h&quot; &quot;e&quot; &quot;e&quot; &quot;a&quot; &quot;j&quot; &quot;h&quot; &quot;a&quot; &quot;d&quot;
##  [91] &quot;e&quot; &quot;f&quot; &quot;j&quot; &quot;j&quot; &quot;c&quot; &quot;j&quot; &quot;f&quot; &quot;d&quot; &quot;b&quot; &quot;i&quot;
</code></pre>
<pre><code class="language-r">text[1:2]
</code></pre>
<pre><code>## $b
##    month.name       col  fontsize
## 1     January #0E0768FF  9.891577
## 2    February #0C8B21FF  7.416968
## 3       March #2C038DFF 12.242896
## 4       April #2AA00CFF 10.454699
## 5         May #74A80DFF  9.777079
## 6        June #4C089AFF  9.825270
## 7        July #4C008FFF  6.179774
## 8      August #0B7C04FF  7.696559
## 9   September #3A810BFF 10.993755
## 10    October #360078FF  8.168969
## 11   November #980228FF  9.337481
## 12   December #960C3DFF 10.450466
## 
## $f
##    month.name       col  fontsize
## 1     January #6E0B9BFF  6.639206
## 2    February #042F7DFF 12.770203
## 3       March #099801FF  9.718325
## 4       April #490E90FF  8.623842
## 5         May #092C79FF 12.441386
## 6        June #0A1274FF  9.944144
## 7        July #051B65FF 13.958028
## 8      August #0A0161FF  6.600719
## 9   September #05833AFF  9.839931
## 10    October #4D7704FF 10.190130
## 11   November #5B098FFF  6.375925
## 12   December #007974FF 10.547464
</code></pre>
<pre><code class="language-r">Heatmap(mat, cluster_rows = FALSE, row_split = split,
    right_annotation = rowAnnotation(wc = anno_textbox(split, text))
)
</code></pre>
<img src="/lab-cn/post/2022-06-15-textbox-annotation_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" />
<pre><code class="language-r">sessionInfo()
</code></pre>
<pre><code>## R version 4.4.2 (2024-10-31)
## Platform: aarch64-apple-darwin20
## Running under: macOS 26.0.1
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0
## 
## locale:
## [1] C.UTF-8/UTF-8/C.UTF-8/C/C.UTF-8/C.UTF-8
## 
## time zone: Europe/Berlin
## tzcode source: internal
## 
## attached base packages:
## [1] grid      stats     graphics  grDevices utils     datasets  methods  
## [8] base     
## 
## other attached packages:
## [1] circlize_0.4.16       ComplexHeatmap_2.25.2 knitr_1.50           
## [4] colorout_1.3-2       
## 
## loaded via a namespace (and not attached):
##  [1] jsonlite_1.9.0      compiler_4.4.2      rjson_0.2.23       
##  [4] crayon_1.5.3        Rcpp_1.0.14         magick_2.8.5       
##  [7] parallel_4.4.2      cluster_2.1.6       jquerylib_0.1.4    
## [10] IRanges_2.40.1      png_0.1-8           yaml_2.3.10        
## [13] fastmap_1.2.0       R6_2.6.1            shape_1.4.6.1      
## [16] Cairo_1.6-2         BiocGenerics_0.52.0 iterators_1.0.14   
## [19] GetoptLong_1.0.5    bookdown_0.44       bslib_0.9.0        
## [22] RColorBrewer_1.1-3  rlang_1.1.5         cachem_1.1.0       
## [25] xfun_0.51           sass_0.4.9          GlobalOptions_0.1.2
## [28] doParallel_1.0.17   cli_3.6.4           magrittr_2.0.3     
## [31] digest_0.6.37       foreach_1.5.2       clue_0.3-66        
## [34] lifecycle_1.0.4     S4Vectors_0.44.0    evaluate_1.0.3     
## [37] blogdown_1.19       codetools_0.2-20    stats4_4.4.2       
## [40] colorspace_2.1-1    rmarkdown_2.29      matrixStats_1.5.0  
## [43] tools_4.4.2         htmltools_0.5.8.1
</code></pre>

  </div>

  <p id="license">本文使用 <a href='https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans'>CC BY-NC-SA 4.0</a> 协议发布。</p>

</section>


<style>
.footer p{
	color: #AAA;
	text-align: left;
	text-decoration: none;
	max-width:400px;
	border-top: 1px solid #AAA;
	padding-top:10px;
	font-size: 0.8em;
}
.footer p a {
	color: #AAA;
	text-align: left;
	text-decoration: none;
}
</style>

<footer class="footer">
<p>网站使用 <a href="https://gohugo.io/">Hugo</a>，<a href="https://bookdown.org/yihui/blogdown/">blogdown</a>，<a href="https://github.com/davidhampgonsalves/hugo-black-and-light-theme">Black & Light 主题</a>创建</p>
</footer>





<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>




<script src="/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


</body>
</html>



